---
title: "Analysis of Taste Adaptation Study"
output: html_document
editor_options: 
  chunk_output_type: console
bibliography: 4b_analysis.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(geepack)
# library(lme4)
library(geex)
source("4a_create_analysis_datasets.r")
```
*PRELIMARY RESULTS*

# Methods

## Outcomes

* primary: changes in suprathreshold intensity
* secondary: changes in detection and recognition thresholds

## Sample Size and Power

The sample size for this pilot study was based on a model-based simulation study of changes in suprathreshold intensity from day 0 to day 5 of fasting. The target of the simulation was estimating 90\% confidence intervals instead of power. This approach for justifying pilot study sample size is recommended when little is known about the parameter(s) of interest over a hypothesis testing approach [@hertzog2008, @moore2011, @lee2014] (Hertzog 2008; Moore et al. 2011; Lee et al. 2014).

## Statistical Analysis

For analysis of suprathreshold intensities, we excluded the zero concentrations as only `r supra_analysis %>% filter(conc ==0, response > 0 ) %>% nrow()` of the `r supra_analysis %>% filter(conc ==0) %>% nrow()` tests had a value other than zero at this concentration. The mean and standard deviation of responses were computed for each assay, concentration, and time point. To estimate the marginal effect of days since start of fast on suprathrehold intensity, a Generalized Estimating Equation (GEE) [@liang1986] model of $log(1 + \text{response})$ was fit with terms for days since start of fast, $log_{10}(\text{concentration})$, and their interaction. Models were fit separately within each taste. Model estimates were transformed back to the original scale are presented with point-wise 90\% confidence intervals.

Statistical analyses were done in `r R.version.string` [@rcore] using the geepack [@geepack], geex [@geex], and ggplot2 [@ggplot2] packages.

TODO: Recognition and Detection thresholds

# Results

TODO: describe subject characteristics 

```{r study_n}
counts <- supra_analysis %>%
  ungroup() %>%
  distinct(record_id, time) %>%
  group_by(time) %>%
  count()
```

All subjects completed the assays at the start of fast, day 5, and end of fast + 3 days. Only `r counts$n[3]` subjects completed the assays at the end of fast timepoint.

## Change in Supratheshold Intensity

Figure `\@ref(fig:supra_days)` displays changes in suprathreshold intensity for salt and sweet taste during the study period. Responses are highly variable between subjects (Table `\@ref(table11)`), but show a general trend of increasing response to salt and descreasing response to sweet. The GEE model fit shows a similar trend.

```{r supra_table, results = 'asis'}
supra_analysis %>%
  ungroup %>% 
  filter(conc > 0) %>%
  group_by(assay_taste, conc, time) %>%
  summarise(
    x = sprintf("%.1f (%.2f)", mean(response), sd(response))
  ) %>% 
  tidyr::spread(
    key = time,
    value = x
  ) %>%
  ungroup() %>%
  mutate(
   assay_taste = factor(
      assay_taste, 
       levels = c("nacl", "sucr"),
       labels = c("NaCL", "Sucrose")),
  ) %>%
  knitr::kable(
    align = c("l", "l", rep("c", 4)),
    col.names = c("Assay", "Concentration", 
                  paste(c("Start of Fast",
                          "Day 5", "End of fast", "End of fast + 3 days"),
                        paste0("(n=", counts$n, ")"))),
    caption = "Mean (Standard deviation) of Suprathreshold repsonses at timepoints"
  )
  

```

```{r supra_model_dt}
supra_model_dt <- supra_analysis %>%
  ungroup %>% 
  filter(conc > 0) %>%
  mutate(
    y = log1p(response),
  ) %>%
  select(y, days, assay_taste, time, c = conc, id = record_id) %>%
  arrange(id) %>%
  group_nest(assay_taste) %>%
  mutate(
    data_pre_to_5 = purrr::map(data, ~ .x %>% filter(time %in% c(1, 2)) )
  )
```

```{r supra_model}
geex_correct <- function(data, model){
  f <- geex::grab_psiFUN(object = model, data = data)
  function(theta){
    f(theta)
  }
}

gee_fit1 <- function(data){
  geepack::geeglm(
    formula = y ~ days * log10(c),
    id   = id,
    data = data, 
    family = gaussian(link = 'identity'))
}

mest <- function(fitter, data){
  m <- fitter(data)
  m_estimate(
    data        = data,
    units       = 'id',
    estFUN      = geex_correct,
    outer_args  = list(model = m),
    corrections = list(fay = correction(
      FUN = fay_bias_correction,
      b   = 0.75)),
    compute_roots  = FALSE,
    roots     = coef(m))
}

get_est <- function(fit, conc = c(50, 100, 200)){
  se <- sqrt(diag(geex::vcov(fit)))
  # se <- sqrt(diag(fit@corrections$fay))
  entries <- expand.grid(
    days = 0:17, 
    conc = conc)
  
  L <- function(d, c){
    c(1, d, log10(c), d * log10(c))
  }
  
  cbind(
    entries, 
    est = apply(entries, 1, function(x){ coef(fit) %*% L(x[1], x[2])}),
    se  = sqrt(apply(entries, 1, function(x){ t(L(x[1], x[2])) %*% vcov(fit) %*% L(x[1], x[2])}))
  )
}

supra_model_dt %>%
  mutate(
    fit_alldays = purrr::map(
      .x = data,
      .f = ~ mest(gee_fit1, .x)),
    est_alldays = purrr::map2(
      .x = fit_alldays, 
      .y = assay_taste,
      .f = ~ {
        if(.y == "sucr") {
          get_est(.x, conc = c(100, 200, 400))
        } else {
          get_est(.x)
        } })
  ) %>%
  select(
    assay_taste, est_alldays
  ) %>%
  tidyr::unnest() %>%
  mutate(
    conf_lo = est - qnorm(.9) * se,
    conf_hi = est + qnorm(.9) * se,
    est     = expm1(est),
    conf_lo = expm1(conf_lo),
    conf_hi = expm1(conf_hi)
  ) -> 
  supra_model_res
```


```{r supra_days}
supra_plot <- supra_analysis %>%
  filter(conc != 0) %>%
  ungroup() %>%
  mutate(
    assay_taste = factor(
      assay_taste, 
       levels = c("nacl", "sucr"),
       labels = c("NaCL", "Sucrose")),
    conc_label  = factor(
      conc, 
      levels = sort(unique(conc)),
      labels = sprintf("%s mg/L", sort(unique(conc))),
      ordered = TRUE)
  )

conc_labs <- distinct(supra_plot, assay_taste, conc, conc_rank, conc_label)

supra_model_plot <- supra_model_res %>%
    mutate(
      assay_taste = factor(
        assay_taste, 
         levels = c("nacl", "sucr"),
         labels = c("NaCL", "Sucrose"))
    ) %>% 
  left_join(
    conc_labs,
    by = c("assay_taste", "conc")
  )
```

```{r supra_plot}
ggplot(supra_plot, 
       aes(x = days, y = response)) + 
  geom_hline(
    yintercept = 0, color = "grey50", size = 0.5
  ) +
  geom_line(
    aes(group = record_id),
    color = "grey80",
    size = .3) + 
  geom_point(
    color = "grey80",
    size = 0.3
  ) + 
  geom_line(
    data = supra_model_plot,
    aes(x = days, y = est, color = assay_taste),
    inherit.aes = FALSE
  ) + 
  geom_ribbon(
    data = supra_model_plot,
    aes(x = days, ymin = conf_lo, ymax = conf_hi, fill = assay_taste),
    alpha = 0.25,
    inherit.aes = FALSE
  ) + 
  geom_text(
    data = conc_labs,
    aes(x = 10, y = 5, label = conc_label),
    hjust = 0, size = 2.5, color = "grey40"
  ) + 
  facet_grid(assay_taste ~ conc_rank) + 
  # stat_smooth(
  #   aes(color = assay_taste),
  #   method = "lm", se = FALSE,
  #   size = 0.5) +
  scale_y_continuous(
    expand = c(0, 0)
  ) + 
  scale_color_manual(
    guide = FALSE,
    values = c("#7b4244", "#60e9dc")
  ) +
  scale_fill_manual(
    guide = FALSE,
    values = c("#7b4244", "#60e9dc")
  ) +
  labs(
    title = "Changes in suprathreshold intensity",
    x = "Days since start of fast",
    y = "Response",
    caption = "Each line is a single subject's trajectory.\nColored lines show GEE model fit with pointwise 90% confidence intervals."
  ) + 
  theme_classic() +
  theme(
    strip.background = element_blank(),
    # strip.background.y = element_blank(),
    strip.text.x  = element_blank(), 
    strip.text.y  = element_text(angle = 0),
    axis.line.x   = element_blank(),
    axis.line.y   = element_line(color = "grey50", size = 0.5),
    axis.ticks.y  = element_line(color = "grey50", size = 0.1),
    axis.ticks.x  = element_line(color = "grey50", size = 0.1),
    axis.text     = element_text(size = 6),
    axis.title.y  = element_text(size = 8),
    axis.title.x  = element_text(size = 8),
    plot.caption  = element_text(size = 6)
  )
```

## Changes in Detection/Recognition Thresholds



```{r dtrt_bytime}
dtrt_dt <- dtrt_thresholds %>% 
  ungroup() %>%
  select(-dtp, -rtp, -taste_order) %>%
  tidyr::gather(key = "type", value = "conc", 
                -record_id, -time, -days, -assay_taste) %>%
  mutate(
    assay_taste = factor(
        assay_taste, 
         levels = c("nacl", "sucr"),
         labels = c("NaCL", "Sucrose")),
    type = factor(
      type,
      levels = c("dt", "rt"),
      labels = c("Detection", "Recognition")
    )
  ) %>%
  group_by(assay_taste, type, record_id) %>%
  arrange(time, .by_group = TRUE) %>%
  mutate(
    conc2 = log1p(conc) - lag(log1p(conc), default = NA)
  )
```

```{r dtrt_table}
dtrt_dt %>%
  group_by(assay_taste, time, type) %>%
  summarise(
    x = sprintf("%.1f (%.2f)", mean(conc), sd(conc))
  ) %>% 
  tidyr::spread(
    key = time,
    value = x
  ) %>%
  knitr::kable(
    align = c("l", "l", rep("c", 4)),
    col.names = c("Assay", "Threshold", 
                  "Start of Fast",
                   "Day 5", "End of fast", "End of fast + 3 days"),
    caption = "Mean (Standard deviation) of thresholds at study timepoints"
  )
```

```{r dtrt_plot}
ggplot(
  data = dtrt_dt,
  aes(x = days, y = log10(conc))
) + 
  geom_hline(
    yintercept = 0, color = "grey50", size = 0.5
  ) +
  geom_point(
    color = "grey80",
    size = 0.8,
    position = position_dodge(width = 1)
  ) + 
  geom_line(aes(group = record_id), alpha = .5) + 
  stat_smooth(
    aes(color = assay_taste), 
    method = "lm", se = FALSE) + 
  scale_color_manual(
    guide = FALSE,
    values = c("#7b4244", "#60e9dc")
  ) +
  facet_grid(assay_taste ~ type, scales = "free_y") + 
  labs(
    title = "Changes in Detection/Recognition Thresholds",
    x = "Days since start of fast"
  ) + 
  theme_classic() +
  theme(
    strip.background = element_blank(),
    # strip.background.y = element_blank(),
    # strip.text.x  = element_blank(), 
    strip.text.y  = element_text(angle = 0),
    axis.line.x   = element_blank(),
    axis.line.y   = element_line(color = "grey50", size = 0.5),
    axis.ticks.y  = element_line(color = "grey50", size = 0.1),
    axis.ticks.x  = element_line(color = "grey50", size = 0.1),
    axis.text     = element_text(size = 6),
    axis.title.y  = element_text(size = 8),
    axis.title.x  = element_text(size = 8),
    plot.caption  = element_text(size = 6)
  )
```


# References

